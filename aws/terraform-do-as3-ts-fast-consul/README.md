# F5 BIG-IP DO, AS3, TS, FAST, Terraform & Consul
- This repository will provision BIG-IP VE (Pay as you Grow), Consul & NGINX servers in AWS

# How to use this repo

To set up a complete new Application on your F5 BIG-IP through DO/AS3 leveraging Consul integration: Follow the steps outlined below.  There are different options for deployment:

- `standalone-single-bigip` deploys a stand-alone big-ip with DO, AS3, Consul and NGINX
- `ha-across-azs` deploys a pair of big-ips, each deployed in separate AZ, with DO, AS3, CFE, Consul and NGINX
- more to come in future

## Provision Infrastructure

The `terraform` directory has tf files for creating instances for consul, f5, iam policy, nginx servers with autoscale group.

- `consul.tf` defines the deployment of Hashicorp Consul, including IAM role/policy
- `f5-*.tf` defines the deployment of big-ip[s] and artifacts required for Cloud Failover Extension (like S3 bucket, IAM role/policy etc)
- `main.tf` refers to what region is used on aws
- `nginx.tf` defines the deployment of the NGINX autoscale group (scale up/down to show Service Discovery in action).
- `ssh.tf` is used to create the key pairs
- `variables.tf` defines the variables for the deployment, such as the prefix used for naming objects
- `vpc.tf` is used to create a new vpc and also to define the aws security groups
- `outputs.tf` is used to output and display F5 BIG-IP management IP and F5 BIG-IP dynamic Password


## Steps 
- Clone the repository & change working directory to terraform
- [Deploy Option 1]`standalone-single-bigip`
- [Deploy Option 2]`ha-across-azs`
```
git clone https://github.com/s-archer/quick-demos-arch
cd quick-demos-arch/aws/terraform-do-as3-ts-fast-consul/`[deploy option]`/terraform/ 
```
- Create Terraform run
- Modify `variables.tf` and update the values to identify you and your resources
- Modify `main.tf` and update the region

```
terraform init
terraform plan
terraform apply
```

  - This will create BIG-IP, consul, NGINX instances on AWS
  - The f5_onboarding.tmpl user-data script will do some initial configuration of the big-ip, including:
      - enable password authentication and modify the admin password.
      - installation of Automation Toolchain (DO, AS3, TS, FAST and CFE).
      - increase resources to allow for installation of the above components.
      - [for HA deployment only] create a LOCAL-ONLY partition, with traffic-group-local-only, to prevent the HA pair trying to sync their default routes (which are different and would otherwise cause sync failure).  This is a work-around because DO cannot create partitions.
  - It may take up to 5 minutes before the run is complete (when the local-exec provisioner detects that AS3 API is ready).
  - The URL & password for the BIG-IP UI are provided as part of the output.
  - The output also contains a string to use for SSH access.  It uses a new SSH key pair created by this deployment.
  - The NGINX instance IP's and TCP ports are registered with Consul, which will allow AS3 to obtain them via Service Discovery, to automatically populate the pool, and elastically scale thereafter. 



## Configure BIG-IP Base Config with DO


Next we need to deploy the DO JSON declaration (see https://github.com/F5Networks/f5-declarative-onboarding for more details)

```
cd ../do/
terraform init
terraform plan
terraform apply
```

- Do terraform plan & apply, this will deploy the DO declarative JSON to the BIG-IP. It will use do.tmpl file, whcih will be populated with addresses taken from the `../terraform/terraform.tfstate` file generated by your first deployment (your source of truth).

## Configure BIG-IP App Service Config with AS3


- Next we need to deploy the AS3 JSON declaration (see https://github.com/F5Networks/f5-appsvcs-extension for more details). 

```
cd ../as3/
terraform init
terraform plan
terraform apply
```

- Do terraform plan & apply, this will deploy the AS3 declarative JSON for service discovery on BIG-IP. It will use nginx.tmpl file, whcih will be populated with addresses taken from the `../terraform/terraform.tfstate` file generated by your first deployment (your source of truth). 
- In addition, AS3 uses Consul for Service Discovery to auto-populate the pool with the NGINX instance IP:ports.

- Now you have Virtual IP and Pool information already configured on BIG-IP in partition defined in the consul.json file.


## Configure BIG-IP HA API Failover with CFE (HA Option Only)


- Finally, we need to deploy the CFE JSON declaration (see https://github.com/F5Networks/f5-appsvcs-extension for more details). 

```
cd ../cfe/
terraform init
terraform plan
terraform apply
```

- Do terraform plan & apply, this will deploy the CFE declarative JSON for HA API Failover on BIG-IP. It will use cfe.json file.
- The configuration will perform an initial failover, to ensure that the BIG-IP HA Active state and the position of the Virtual Server EIPs are coordinated to the same BIG-IP.


# How to test?
- You can access backend applications using the URL provided in the output.
- The NGINX servers are already in Auto scale group with consul agents running and sending all information to Consul server.
- Use case is when you destroy or bring down  one of the NGINX server, BIG-IP AS3 will poll the consul server and update the pool members automatically
- So as the NGINX servers are going up and down the BIG-IP Pool members are updated automatically without manual intervention.  
- Use http://consul_public_IP:8500 (provided in the first terraform output) to access the consul server and check the status of consul nodes count


### Folder scripts
`consul.sh` is used to install consul
`nginx.sh` is used to install consul agent on nginx servers


### To Destroy

- To destroy the deployment gracefully, run the following commands:

```
cd ../cfe/
terraform destroy

cd ../as3/
terraform destroy

cd ../do/
terraform destroy

cd ../terraform/
terraform destroy
```
